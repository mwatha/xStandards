<%=javascript_include_tag "prototype"%>                                         
<%=javascript_include_tag "jquery_data_table" %>                                
<%=javascript_include_tag "jquery.dataTables.min" %>                            
                                                                                
<%= stylesheet_link_tag "demo_table" %>                                         
<%= stylesheet_link_tag "demo_table_jui" %>                                     
<%= stylesheet_link_tag "demo_page" %>

<%=javascript_include_tag "popup" %>
<%= stylesheet_link_tag "popup" %>

<style>
                                                                                
</style>

<script>

  function dataT(){                                                               
    $('#search_results').dataTable();                                                  
  }

  function findStudents() {                                                       
    var search_str = document.getElementById('search_words').value;               
                                                                                
    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
        xmlhttp=new XMLHttpRequest();                                             
      }else{// code for IE6, IE5                                                  
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
      }                                                                           
      xmlhttp.onreadystatechange=function() {                                     
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
          var results = xmlhttp.responseText;                                     
          if(results == 'undefined' || results == '' || results == '"not validate"') {                           
            return;                                                               
          }else{                                                                  
            document.getElementById('results-cont').innerHTML = results;                                                           
            dataT();                                                              
          }                                                                       
        }                                                                         
      }                                                                           
      xmlhttp.open("GET","/assets/live_search?search_str="+search_str,true);           
      xmlhttp.send();                                                             
    } 
 
</script>


<div class="page-header">
  <h1>sample <small>raw data search (market control)</small></h1>
</div>

<section id='modals'>                                              
  <table id="search_results" class="table table-striped table-bordered table-condensed">
  <thead>                                                                       
  <tr id = 'table_head'>                                                        
    <th id="th1" style="width:10%;">District</th>                           
    <th id="th2" style="width:10%;">Trading center</th>                           
    <th id="th1" style="width:5%;">Salt type</th>                           
    <th id="th2" style="width:10%;">Salt brand (origin)</th>                           
    <th id="th2" style="width:5%;">Result</th>  
    <th id="th2" style="width:12%;">Category</th>  
    <th id="th2" style="width:10%;">Date entered</th>  
    <th id="th2" style="width:7%;">Quater</th>  
    <th id="th10" style="width:5%;">&nbsp;</th>                               
  </tr>                                                                         
  </thead>                                                                      
  <tbody id='results'>                                                          
    <%(@samples || []).each do |sample_id,values| %>                                    
    <tr>                                                                        
      <td><%=values[:district]%></td>                                            
      <td><%=values[:market]%></td>                                            
      <td><%=values[:salt_type]%></td>                                            
      <td><%=values[:manufacturer]%></td>                                            
      <td><%=values[:iodine_level]%></td>                                            
      <td><%=values[:category]%></td>                                            
      <td><%=values[:date]%></td>                                            
      <td><%=values[:quater]%></td>                                            
      <td><a href="#" onclick="showLayer(<%=sample_id%>);">Edit</a></td> 
    </tr>                                                                       
    <%end%>                                                                     
  </tbody>                                                                      
  </table>
</section> 


<script>                                                                        
  dataT();                                                                      
</script>


<div id="shadow" class="shadowLayer"> </div>
<div id="question" class="dialogLayer" style="font-size: 0.9em;overflow: auto;background-color:#e0e0e0;">
  <div class="modal-header" >
    <button type="button" class="close" style="color: #000000 !important;" onmousedown="hideLayer()"><span aria-hidden="true" >&times;</span></button>
    <h2 id="popup_title">Edit</h2>
  </div>
<div >
<div id="comment_container" style="text-align: justify;background-color: #ebebeb;">

</div>

<div id="notice_container" style="text-align: left;">
  <form method="post" action="update_notice">
      &nbsp; <br/>
      <table id="popuptable">
        <tr>
          <td>Date</td><td><%=text_field(:input, "popupdate",:class => "input_data", :id => "popupdate") %></td>
        </tr>
        <tr>
          <td>Select market</td>
          <td>
            <%@markets.unshift('Select market') %>
            <%= select_tag "transporter", options_for_select(@markets),
            :class => "input_data", :id => "market" %>
          </td>
        </tr>
        <tr>
          <td>Salt type</td>
          <td>
            <%@salt_types.unshift('Select salt type') %>
            <%= select_tag "salt_type", options_for_select(@salt_types),
            :class => "input_data", :id => "salt_type" %>
          </td>
        </tr>
        <tr>
          <td>Salt brand(origin)</td>
          <td>
            <%@manufacturers.unshift('Select manufacturer') %>
            <%= select_tag "manufacturer", options_for_select(@manufacturers),
            :class => "input_data", :id => "manufacturer" %>
          </td>
        </tr>
        <tr>
          <td>Iodine level</td>
          <td>
            <input type="text" name="result" class='input_data' 
              onkeyup = "setCategory(this);" id="result" />
          </td>
        </tr>
        <tr>
          <td>Category</td><td><input type="text" disabled='disabled' id="category" /></td>
        </tr>
      </table>
      <input type="hidden" name="record_id" id="record_id" value="" />
    <hr>
    <input type='button' style="float: right;" class="btn btn-success" value="Save changes" onmousedown="saveChanges()" id="save_changes">
    <button  class="btn btn-danger" style="float: right;margin-right: 10px;" onmousedown="hideLayer()">Close</button>
  </form>
</div>
</div>
 </div>
</div>


<%#= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %>
<%#= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<%#= javascript_include_tag "zebra_datepicker" %>
<%#= stylesheet_link_tag "default" %>

<script>

function setCategory(element) {                                               
  sample_iodine_category = document.getElementById("category");
                                                          
  try{                                                                          
    var level = parseFloat(element.value);                          
    if(!level) {                                                                
      sample_iodine_category.value = null;                                      
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
                                                          
  if(level < 25){                                                               
    sample_iodine_category.value = "Below Market Min";                          
  }else if(level >= 25 && level <= 49.9 ){                                      
    sample_iodine_category.value = "Factory Min-Market Min";                    
  }else if(level < 50){                                                         
    sample_iodine_category.value = "< Factory Min";                             
  }else if(level >= 50 && level <= 84){                                         
    sample_iodine_category.value = "Production Range";                          
  }else if(level > 84){                                                         
    sample_iodine_category.value = "> Factory Max";                             
  }                                                                             

}

function saveChanges() {
  var selected_date = document.getElementById("popupdate"); 
  var market = document.getElementById("market"); 
  var manufacturer = document.getElementById("manufacturer"); 
  var salt_type = document.getElementById("salt_type"); 
  var entered_result = document.getElementById("result"); 
  var cat = document.getElementById("category"); 

  if (selected_date.value.length < 1) {
  }else if(market.value.length < 1) {
  }else if(manufacturer.value.length < 1) {
  }else if(salt_type.value.length < 1) {
  }else if(entered_result.value.length < 1) {
  }else if(cat.value.length < 1) {
    return;
  }

  var url = "sample[market]=" + market.value;                                                                         
  url += "&sample[salt_type]=" + salt_type.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[manufacturer]=" + manufacturer.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;
  url += "&sample[sample_id]=" + document.getElementById('record_id').value;


  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = xmlhttp.responseText;                                     
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          alert('Updated record');
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/raw_data_market_update?" + url, true);           
    xmlhttp.send();
}
</script>

<style>
  .dialogLayer {
    height: 380px !important;
  }
</style> 
