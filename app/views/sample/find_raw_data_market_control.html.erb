<%=javascript_include_tag "prototype"%>                                         
<%=javascript_include_tag "jquery_data_table" %>                                
<%=javascript_include_tag "jquery.dataTables.min" %>                            
                                                                                
<%= stylesheet_link_tag "demo_table" %>                                         
<%= stylesheet_link_tag "demo_table_jui" %>                                     
<%= stylesheet_link_tag "demo_page" %>

<%=javascript_include_tag "popup" %>
<%= stylesheet_link_tag "popup" %>

<%= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %>
<%= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<style>
  #finish {
    bottom: 30px;
    float: right;
    position: relative;
  }                                                                                
</style>

<script>

  function dataT(){                                                               
    $('#search_results').dataTable();                                                  
  }

  function findStudents() {                                                       
    var search_str = document.getElementById('search_words').value;               
                                                                                
    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
        xmlhttp=new XMLHttpRequest();                                             
      }else{// code for IE6, IE5                                                  
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
      }                                                                           
      xmlhttp.onreadystatechange=function() {                                     
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
          var results = xmlhttp.responseText;                                     
          if(results == 'undefined' || results == '' || results == '"not validate"') {                           
            return;                                                               
          }else{                                                                  
            document.getElementById('results-cont').innerHTML = results;                                                           
            dataT();                                                              
          }                                                                       
        }                                                                         
      }                                                                           
      xmlhttp.open("GET","/assets/live_search?search_str="+search_str,true);           
      xmlhttp.send();                                                             
    } 
 
</script>


<div class="page-header">
  <h3>MARKET CONTROL <small>SUMMARY  OF SALT DETAILS AND RESULTS</small></h3>
  <input type="button" class="btn btn-primary" 
    value="Back to menu" id="finish"onclick="document.location='/mark'" />
</div>

<section id='modals'>                                              
  <table id="search_results" class="table table-striped table-bordered table-condensed">
  <thead>                                                                       
  <tr id = 'table_head'>                                                        
    <th id="th1" style="width:7%;">Collection date</th>                           
    <th id="th2" style="width:10%;">County</th>                           
    <th id="th1" style="width:10%;">Sub-county</th>                           
    <th id="th2" style="width:10%;">Trading center</th>                           
    <th id="th2" style="width:10%;">Manufacturer</th>  
    <th id="th2" style="width:10%;">Salt brand</th>  
    <th id="th2" style="width:7%;">Iodine(mg/kg iodate)</th>  
    <th id="th2" style="width:10%;">Category</th>  
    <th id="th10" style="width:5%;">&nbsp;</th>                               
    <th id="th10" style="width:5%;">&nbsp;</th>                               
  </tr>                                                                         
  </thead>                                                                      
  <tbody id='results'>                                                          
    <%(@samples || []).each do |sample_id,values| %>                                    
    <tr>                                                                        
      <td id="date_<%=sample_id%>"><%=values[:date]%></td>                                            
      <td id="county_<%=sample_id%>"><%=values[:county]%></td>                                            
      <td id="subcounty_<%=sample_id%>"><%=values[:subcounty]%></td>                                            
      <td id="market_<%=sample_id%>"><%=values[:market]%></td>                                            
      <td id="manufacturer_<%=sample_id%>"><%=values[:manufacturer]%></td>                                            
      <td id="salt_brand_<%=sample_id%>"><%=values[:salt_brand]%></td>                                            
      <td id="iodine_level_<%=sample_id%>"><%=values[:iodine_level]%></td>                                            
      <td id="category_<%=sample_id%>"><%=values[:category]%></td>                                            
      <!--td><a href="/edit_market/<%#=sample_id%>">Edit/delete</a></td-->       
      <td><a href="#" onclick="showLayer(<%=sample_id%>);fillForm(<%=sample_id%>);setDate();">Edit</a></td> 
      <td><a href="#" onclick="deleteRecord(<%=sample_id%>);">Delete</a></td> 
    </tr>                                                                       
    <%end%>                                                                     
  </tbody>                                                                      
  </table>
</section> 


<script>                                                                        
  dataT();                                                          
  
  function deleteRecord(sample_id) {
    var r = confirm("Are you sure you want to delete this record?");
    if (r == true) {
      document.location="/delete_entered_data/" + sample_id + "/market";           
    } 
  }             
</script>


<div id="shadow" class="shadowLayer"> </div>
<div id="question" class="dialogLayer" style="font-size: 0.9em;overflow: auto;background-color:#e0e0e0;">
  <div class="modal-header" >
    <button type="button" class="close" style="color: #000000 !important;" onmousedown="hideLayer()"><span aria-hidden="true" >&times;</span></button>
    <h2 id="popup_title">Edit</h2>
  </div>
<div >
<div id="comment_container" style="text-align: justify;background-color: #ebebeb;">

</div>

<div id="notice_container" style="text-align: left;">
  <form method="post" action="update_notice">
      &nbsp; <br/>
      <table id="popuptable">
        <tr>
          <td>Date</td><td><%=text_field(:input, "popupdate",:class => "input_data", :id => "popupdate", :readonly => "readonly") %></td>
        </tr>
        <tr>
          <td>Select market</td>
          <td>
            <%#@markets.unshift('Select market') %>
            <%= select_tag "transporter", options_for_select(@markets),
            :class => "input_data", :id => "market" %>
          </td>
        </tr>
        <tr>
          <td>Sub county</td>
          <td>
            <%#@subcounties.unshift('Select sub county') %>
            <%= select_tag "subcounty", options_for_select(@subcounties),
            :class => "input_data", :id => "subcounty" %>
          </td>
        </tr>
        <tr>
          <td>Salt brand(origin)</td>
          <td>
            <%#@manufacturers.unshift('Select manufacturer') %>
            <%= select_tag "salt_brand", options_for_select(@manufacturers),
            :class => "input_data", :id => "salt_brand" %>
          </td>
        </tr>
        <tr>
          <td>Iodine level</td>
          <td>
            <input type="text" name="result" class='input_data' 
              onkeyup = "setCategory(this);" id="result" />
          </td>
        </tr>
        <tr>
          <td>Category</td><td><input type="text" disabled='disabled' id="category" /></td>
        </tr>
      </table>
      <input type="hidden" name="record_id" id="record_id" value="" />
    <hr>
    <input type='button' style="float: right;" class="btn btn-success" value="Save changes" onmousedown="saveChanges()" id="save_changes">
    <button  class="btn btn-danger" style="float: right;margin-right: 10px;" onmousedown="hideLayer()">Close</button>
  </form>
</div>
</div>
 </div>
</div>


<%#= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %>
<%#= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<script>

function setCategory(element) {                                               
  sample_iodine_category = document.getElementById("category");
                                                          
  try{                                                                          
    var level = parseFloat(element.value);                          
    if(!level) {                                                                
      sample_iodine_category.value = null;                                      
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
   
  sample_iodine_category.value = sCategory(level);                                                       

}

function saveChanges() {
  var selected_date = document.getElementById("popupdate"); 
  var market = document.getElementById("market"); 
  var manufacturer = document.getElementById("salt_brand"); 
  var subcounty = document.getElementById("subcounty"); 
  var entered_result = document.getElementById("result"); 
  var cat = document.getElementById("category"); 

  if (selected_date.value.length < 1) {
  }else if(market.value.length < 1) {
  }else if(manufacturer.value.length < 1) {
  }else if(subcounty.value.length < 1) {
  }else if(entered_result.value.length < 1) {
  }else if(cat.value.length < 1) {
    return;
  }

  var url = "sample[market]=" + market.value;                                                                         
  url += "&sample[sub_county]=" + subcounty.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[manufacturer]=" + manufacturer.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;
  url += "&sample[sample_id]=" + document.getElementById('record_id').value;


  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = xmlhttp.responseText;                                     
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          alert('Updated record');
          location.reload();
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/raw_data_market_update?" + url, true);           
    xmlhttp.send();
}


var all_markets = {};
var all_manufacturers = {};
var all_salt_brand = {};
var all_sub_counties = {};

<%@markets.each do |name,id|%>
  if(!all_markets["<%= name %>"])
        all_markets["<%= name %>"] = [];
   
  all_markets["<%= name %>"].push(<%= id %>);
<%end%>

<%@subcounties.each do |name,id|%>
  if(!all_sub_counties["<%= name %>"])
        all_sub_counties["<%= name %>"] = [];
   
  all_sub_counties["<%= name %>"].push(<%= id %>);
<%end%>

<%@manufacturers.each do |name,id|%>
  if(!all_manufacturers["<%= name %>"])
        all_manufacturers["<%= name %>"] = [];
   
  all_manufacturers["<%= name %>"].push(<%= id %>);
<%end%>

<%@subcounties.each do |name,id|%>
  if(!all_sub_counties["<%= name %>"])
        all_sub_counties["<%= name %>"] = [];
   
  all_sub_counties["<%= name %>"].push(<%= id %>);
<%end%>

function fillForm(sample_id) {
  //document.getElementById('popupdate').value = document.getElementById("date_" + sample_id).innerHTML;                                             

  document.getElementById('market').options[0].innerHTML = document.getElementById("market_" + sample_id).innerHTML;                                             
  document.getElementById('market').value = all_markets[document.getElementById("market_" + sample_id).innerHTML];                                             

  document.getElementById('subcounty').options[0].innerHTML = document.getElementById("subcounty_" + sample_id).innerHTML;                                             
  document.getElementById('subcounty').value = all_sub_counties[document.getElementById("subcounty_" + sample_id).innerHTML];                                             
  
  document.getElementById('salt_brand').options[0].innerHTML = document.getElementById("manufacturer_" + sample_id).innerHTML;                                             
  document.getElementById('salt_brand').value = all_manufacturers[document.getElementById("manufacturer_" + sample_id).innerHTML];

  document.getElementById('result').value = document.getElementById("iodine_level_" + sample_id).innerHTML;                                             
  document.getElementById('category').value = document.getElementById("category_" + sample_id).innerHTML;                                             

}

var currDate = new Date();
var dateNow =  currDate.getDate();
var yrNow =  currDate.getFullYear();
var monthNow =  (currDate.getMonth() + 1);


function setDate(){
  new JsDatePick({
    useMode:2,
    target: 'popupdate' ,
    dateFormat:"%d-%M-%Y",
    selectedDate:{       
      day: dateNow,            
      month: monthNow,
      year: yrNow
    },
    yearsRange:[1900,yrNow],
    limitToToday: true,
    cellColorScheme:"beige",
    dateFormat:"%d-%m-%Y",
    imgPath:"img/",
    weekStartDay:1
  });
};

function sCategory(result) {                                               
  category = null;
                                                          
  try{                                                                          
    var level = parseFloat(result);                          
    if(!level) {                                                                
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
                                                          
  if(level < 25){                                                               
    return "Below Market Min";                          
  }else if(level >= 25 && level <= 49.9 ){                                      
    return "Factory Min-Market Min";                    
  }else if(level < 50){                                                         
    return "< Factory Min";                             
  }else if(level >= 50 && level <= 84){                                         
    return "Production Range";                          
  }else if(level > 84){                                                         
    return "> Factory Max";                             
  }                                                                             

}

</script>

<style>
.dialogLayer {
  height: 380px !important;
}
</style> 
