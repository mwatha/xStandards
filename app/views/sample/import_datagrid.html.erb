<style>
  #content-heading {                                                                 
    color: #404040;                                                               
    font-family: Verdana,Tahoma,Arial;                                            
    font-size: 14px;                                                              
    width: 99%;   
    background: none repeat scroll 0 0 rgb(255, 235, 144);                      
    height: auto;                                                               
    border: 1px solid #696969;                                                              
    padding: 10px;
  }

  #search_results {
    font-size: 10px;
    border-style: solid;
    border-width: 1px;
  }  

  #search_results td , th{
    font-size: 10px;
    border-style: solid;
    border-width: 1px;
  }  

  .input_data {
    width:120px;
  }

  #finish {
    bottom: 30px;
    float: right;
    position: relative;
  }

</style>

<%= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %> 
<%= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<script>
 var currDate = new Date();
 var dateNow =  currDate.getDate();
 var yrNow =  currDate.getFullYear();
 var monthNow =  (currDate.getMonth() + 1);

 function setDate(id){
    new JsDatePick({
      useMode:2,
      target: id ,
      dateFormat:"%d-%M-%Y",
      selectedDate:{       
        day: dateNow,            
        month: monthNow,
        year: yrNow
      },
      yearsRange:[1900,yrNow],
      limitToToday: true,
      cellColorScheme:"beige",
      dateFormat:"%d-%m-%Y",
      imgPath:"img/",
      weekStartDay:1
    });
  };


 function setDateDynamically(id,nowYr,nowMonth,nowDate){
    set_date = new Date(nowYr, (nowMonth - 1), nowDate);
    new JsDatePick({
      useMode:2,
      target: id ,
      dateFormat:"%d-%M-%Y",
      selectedDate:{       
        day: set_date.getDate(),            
        month: set_date.getMonth(),
        year: set_date.getFullYear()
      },
      yearsRange:[1900,yrNow],
      limitToToday: true,
      cellColorScheme:"beige",
      dateFormat:"%d-%m-%Y",
      imgPath:"img/",
      weekStartDay:1
    });
  };


    function insertRow(e , ev) {
      if(ev.keyCode == 13) {
        id = "input_date" + (parseInt(e.id) - 7);      
        saveRecord(document.getElementById(id));                                                                                
        return;
      }
    }

    function addRow() {
        var colCount = 9
        var table = document.getElementById('search_results');

        var rowCount = table.rows.length;
        var row = table.insertRow(rowCount - 1);

        
        for(var i = 0; i < colCount; i++) {
          cell = row.insertCell(i);
          classRow = " row" + rowCount;
          name = "XXX";
          colID = (parseInt(rowCount) + parseInt(i) + 10);
          if(i == 0) {
            valueEntered = document.getElementById("input_date" + i).value;
            document.getElementById("input_date" + i).value = null;
          }else{
            valueEntered = document.getElementById(i).value;
            document.getElementById(i).value = null;
          }

          if(i == 8) {
            element = "<input disabled='disabled' class='input_data" + classRow + "' type='text' name='" + name + "' id='" + colID + "' value='" + valueEntered +"'/>";
            document.getElementById("1").focus();
            cell.innerHTML = element;
          }else if(i == 7){
            element = "<input onkeyup='updateRow(this,event," + (rowCount - 1) + ");sampleIodineCategory(this);' onchange = 'sampleIodineCategory(this);'  class='input_data" + classRow + "' type='text' name='" + name + "' id='" + colID + "' value='" + valueEntered +"'/>";
            cell.innerHTML = element;
          }else if(i == 2){
            cell.innerHTML = addSelectBorder(valueEntered,classRow,name,colID);
          }else if(i == 3){
            cell.innerHTML = addSelectImporter(valueEntered,classRow,name,colID);
          }else if(i == 4){
            cell.innerHTML = addSelectSaltType(valueEntered,classRow,name,colID);
          }else if(i == 5){
            cell.innerHTML = addSelectCountry(valueEntered,classRow,name,colID);
          }else if(i == 0){
            element = "<input class='input_data" + classRow + "' type='text' name='" + name + "' id='input_date" + colID + "' value='" + valueEntered +"'/>";
            cell.innerHTML = element;
            nowYr = parseInt(valueEntered.split('-')[2]);
            nowMonth = parseInt(valueEntered.split('-')[1]);
            nowDate = parseInt(valueEntered.split('-')[0]);
            setDateDynamically(("input_date" + colID),nowYr,nowMonth,nowDate);
          }else{
            element = "<input class='input_data" + classRow + "' type='text' name='" + name + "' id='" + colID + "' value='" + valueEntered +"'/>";
            cell.innerHTML = element;
          }
        }
    }
            
    
    function addSelectSaltType(valueEntered,classRow,name,colID) {
      var saltSelect = document.createElement('Select');
      saltSelect.setAttribute("class",classRow + " input_data");
      saltSelect.setAttribute("name",name);
      saltSelect.setAttribute("id",colID);
      var selectDiv = document.createElement('Div');

      <%@salt_brands.each do |name , id| %>
        if (parseInt(valueEntered) == parseInt(<%=id%>)) {
          var opt = document.createElement('option');
          opt.value = <%=id%>;
          opt.textContent = "<%=name%>";
          saltSelect.appendChild(opt);
        }
      <%end%>

      <%@salt_brands.each do |name , id| %>
        var opt = document.createElement('option');
        opt.value = <%=id%>;
        opt.textContent = "<%=name%>";
        saltSelect.appendChild(opt);
      <%end%>

      selectDiv.appendChild(saltSelect);
      return selectDiv.innerHTML;
  
    }


    function addSelectImporter(valueEntered,classRow,name,colID) {
      var importerSelect = document.createElement('Select');
      importerSelect.setAttribute("class",classRow + " input_data");
      importerSelect.setAttribute("name",name);
      importerSelect.setAttribute("id",colID);
      var selectDiv = document.createElement('Div');

      <%@markets.each do |name , id| %>
        if (parseInt(valueEntered) == parseInt(<%=id%>)) {
          var opt = document.createElement('option');
          opt.value = <%=id%>;
          opt.textContent = "<%=name%>";
          importerSelect.appendChild(opt);
        }
      <%end%>

      <%@markets.each do |name , id| %>
        var opt = document.createElement('option');
        opt.value = <%=id%>;
        opt.textContent = "<%=name%>";
        importerSelect.appendChild(opt);
      <%end%>

      selectDiv.appendChild(importerSelect);
      return selectDiv.innerHTML;
    } 


    function addSelectBorder(valueEntered,classRow,name,colID) {
      var borderSelect = document.createElement('Select');
      borderSelect.setAttribute("class",classRow + " input_data");
      borderSelect.setAttribute("name",name);
      borderSelect.setAttribute("id",colID);
      var selectDiv = document.createElement('Div');

      <%@borders.each do |name , id| %>
        if (parseInt(valueEntered) == parseInt(<%=id%>)) {
          var opt = document.createElement('option');
          opt.value = <%=id%>;
          opt.textContent = "<%=name%>";
          borderSelect.appendChild(opt);
        }
      <%end%>

      <%@borders.each do |name , id| %>
        var opt = document.createElement('option');
        opt.value = <%=id%>;
        opt.textContent = "<%=name%>";
        borderSelect.appendChild(opt);
      <%end%>

      selectDiv.appendChild(borderSelect);
      return selectDiv.innerHTML;
  
    }


    function addSelectCountry(valueEntered,classRow,name,colID) {
      var borderSelect = document.createElement('Select');
      borderSelect.setAttribute("class",classRow + " input_data");
      borderSelect.setAttribute("name",name);
      borderSelect.setAttribute("id",colID);
      var selectDiv = document.createElement('Div');

      <%@countries.each do |name , id| %>
        if (parseInt(valueEntered) == parseInt(<%=id%>)) {
          var opt = document.createElement('option');
          opt.value = <%=id%>;
          opt.textContent = "<%=name%>";
          borderSelect.appendChild(opt);
        }
      <%end%>

      <%@countries.each do |name , id| %>
        var opt = document.createElement('option');
        opt.value = <%=id%>;
        opt.textContent = "<%=name%>";
        borderSelect.appendChild(opt);
      <%end%>

      selectDiv.appendChild(borderSelect);
      return selectDiv.innerHTML;
  
    }

</script>


<div class="page-header">                                                       
  <h3>Import Control&nbsp;<small>INPUT SALT DETAILS AND RESULTS</small></h3>   
  <input type="button" class="btn btn-primary" 
    value="Back to menu" id="finish"onclick="document.location='/prod'" />                           
</div>

<section id='modals'>                                              
  <div class="content-details">
  
  <table id='search_results' class='table table-striped table-bordered table-condensed'>
  <thead>                                                                       
  <tr id = 'table_head'>                                                        
    <th id="th3" style="">Date</th>                                 
    <th id="th1" style="">IIR Code</th>                               
    <th id="th4" style="">Point of Entry</th>                             
    <th id="th5" style="">Importer</th>                                
    <th id="th5" style="">Country of origin</th>                                
    <th id="th5" style="">Salt brand</th>                                
    <th id="th5" style="">Volume (tons)</th>                                
    <th id="th5" style="">IODINE (mg/kg IODATE)</th>                                
    <th id="th5" style="">Category</th>                                
  </tr>                                                                         
  </thead>                                                                      
  <tbody id='results'>                                                          
    <tr>                                                                        
      <td><!--input type="text" name="date" class='input_data' id="0" /></td-->
        <%=text_field(:input, "date0",:class => "input_data", :readonly => "readonly") %></td>
      <td><input type="text" name="iir_code" class='input_data' id="1" /></td>
      <td>
        <%@borders.unshift('Select entry point') %>                      
        <%= select_tag "border", options_for_select(@borders), 
            :class => "input_data", :id => "2" %>
      </td>
      <td>
        <%@markets.unshift('Select importer') %>                      
        <%= select_tag "market", options_for_select(@markets), 
            :class => "input_data", :id => "3" %>
      </td>                                                      
      <td>
        <%@countries.unshift('Select country') %>                      
        <%= select_tag "brand", options_for_select(@countries), 
            :class => "input_data", :id => "5" %>
      </td>                                                      
      <td>
        <%@salt_brands.unshift('Select salt brand') %>                      
        <%= select_tag "type", options_for_select(@salt_brands), 
            :class => "input_data", :id => "4" %>
      </td>                                                      
      <td><input type="text" name="volume" class='input_data' id="6" /></td>                                                      
      <td>
        <input type="text" name="result" class='input_data' onkeyup="insertRow(this,event);sampleIodineCategory(this);" onchange = "sampleIodineCategory(this);" id="7" />
      </td>
      <td><input disabled='disabled' type="text" name="category" class='input_data' id="8" /></td>
    </tr>                                                                       
  </tbody>                                                                      
</table>                                                                      
</div>

</section> 

<script>

var created_sample_ids = [];

function sampleIodineCategory(element) {                                               
  sampleIodineLevelID = (parseInt(element.id) + 1);
  sample_iodine_category = document.getElementById(sampleIodineLevelID);
                                                          
  try{                                                                          
    var level = parseFloat(element.value);                          
    if(!level) {                                                                
      sample_iodine_category.value = null;                                      
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
                                                          
  if(level < 25){                                                               
    sample_iodine_category.value = "Below Market Min";                          
  }else if(level >= 25 && level <= 49.9 ){                                      
    sample_iodine_category.value = "Factory Min-Market Min";                    
  }else if(level < 50){                                                         
    sample_iodine_category.value = "< Factory Min";                             
  }else if(level >= 50 && level <= 84){                                         
    sample_iodine_category.value = "Production Range";                          
  }else if(level > 84){                                                         
    sample_iodine_category.value = "> Factory Max";                             
  }                                                                             

}

function saveRecord(element) {                                                           
  var selected_date = element;            
  var elementID = parseInt(element.id.split('input_date')[1]);
  var iir_code = document.getElementById(elementID + 1); 
  var entry = document.getElementById(elementID + 2); 
  var importer = document.getElementById(elementID + 3); 
  var brand = document.getElementById(elementID + 4); 
  var country = document.getElementById(elementID + 5); 
  var volume = document.getElementById(elementID + 6); 
  var entered_result = document.getElementById(elementID + 7); 
  var cat = document.getElementById(elementID + 8); 

  if (selected_date.value.length < 1) {
    alert('Select a transaction date');
    return;
  }else if(iir_code.value.length < 1) {
    alert('Enter IIR code');
    return;
  }else if(entry.value == 'Select entry point' ) {
    alert('Select entry point');
    return;
  }else if(importer.value == 'Select importer') {
    alert('Select importer');
    return;
  }else if(brand.value == 'Select salt brand') {
    alert('Select salt brand');
    return;
  }else if(country.value == 'Select country') {
    alert('Select country');
    return;
  }else if(volume.value.length < 1) {
    alert('Enter volume of import');
    return;
  }else if(entered_result.value.length < 1) {
    alert('Enter result');
    return;
  }else if(cat.value.length < 1) {
    alert('Enter result');
    return;
  }

  var url = "sample[iir_code]=" + iir_code.value;                                                                         
  url += "&sample[border]=" + entry.value;                                                                         
  url += "&sample[importer]=" + importer.value;                                                                         
  url += "&sample[salt_brand]=" + brand.value;                                                                         
  url += "&sample[country]=" + country.value;                                                                         
  url += "&sample[volume]=" + volume.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;                                                                         

  addRow(); 

  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          sample_id = results.split("sample id:")[1];  
          created_sample_ids.push(sample_id)    
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/create_quality_monitoring_raw_data?" + url, true);           
    xmlhttp.send();                                                             
  }
  
function updateRow(element , ev , rowCount) {      
  if(ev.keyCode != 13)
    return;
    
  var elementID = (parseInt(element.id) - 7);
  var selected_date = document.getElementById("input_date" + elementID); 
  var iir_code = document.getElementById(elementID + 1); 
  var entry = document.getElementById(elementID + 2); 
  var importer = document.getElementById(elementID + 3); 
  var brand = document.getElementById(elementID + 4); 
  var country = document.getElementById(elementID + 5); 
  var volume = document.getElementById(elementID + 6); 
  var entered_result = document.getElementById(elementID + 7); 
  var cat = document.getElementById(elementID + 8); 

  if (selected_date.value.length < 1) {
  }else if(iir_code.value.length < 1) {
  }else if(entry.value.length < 1) {
  }else if(importer.value.length < 1) {
  }else if(brand.value.length < 1) {
  }else if(volume.value.length < 1) {
  }else if(entered_result.value.length < 1) {
  }else if(country.value.length < 1) {
  }else if(cat.value.length < 1) {
    return;
  }

  var url = "sample[iir_code]=" + iir_code.value;                                                                         
  url += "&sample[border]=" + entry.value;                                                                         
  url += "&sample[importer]=" + importer.value;                                                                         
  url += "&sample[salt_brand]=" + brand.value;                                                                         
  url += "&sample[country]=" + country.value;                                                                         
  url += "&sample[volume]=" + volume.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;                                                                         

  sample_id = created_sample_ids[(rowCount - 1)];
  if(sample_id.length < 1)         
    return;

  url += "&sample[sample_id]=" + sample_id;

  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = xmlhttp.responseText;                                     
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          alert('Updated record');
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/update_quality_monitoring_raw_data?" + url, true);           
    xmlhttp.send();                                                             
  }
  
  setDate(document.getElementById('input_date0').id);

</script>
