<%=javascript_include_tag "prototype"%>                                         
<%=javascript_include_tag "jquery_data_table" %>                                
<%=javascript_include_tag "jquery.dataTables.min" %>                            
                                                                                
<%= stylesheet_link_tag "demo_table" %>                                         
<%= stylesheet_link_tag "demo_table_jui" %>                                     
<%= stylesheet_link_tag "demo_page" %>

<%=javascript_include_tag "popup" %>
<%= stylesheet_link_tag "popup" %>

<%= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %>
<%= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<style>
                                                                                
</style>

<script>

  function dataT(){                                                               
    $('#search_results').dataTable();                                                  
  }

  function findStudents() {                                                       
    var search_str = document.getElementById('search_words').value;               
                                                                                
    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
        xmlhttp=new XMLHttpRequest();                                             
      }else{// code for IE6, IE5                                                  
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
      }                                                                           
      xmlhttp.onreadystatechange=function() {                                     
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
          var results = xmlhttp.responseText;                                     
          if(results == 'undefined' || results == '' || results == '"not validate"') {                           
            return;                                                               
          }else{                                                                  
            document.getElementById('results-cont').innerHTML = results;                                                           
            dataT();                                                              
          }                                                                       
        }                                                                         
      }                                                                           
      xmlhttp.open("GET","/assets/live_search?search_str="+search_str,true);           
      xmlhttp.send();                                                             
    } 
 
</script>


<div class="page-header">
  <h3>INDUSTRY CONTROL <small>SUMMARY OF SALT DETAILS AND RESULTS ENTERED</small></h3>
</div>

<section id='modals'>                                              
  <table id="search_results" class="table table-striped table-bordered table-condensed">
  <thead>                                                                       
  <tr id = 'table_head'>                                                        
    <th id="th2" style="width:10%;">Collecion date</th>  
    <th id="th1" style="width:6%;">CIS code</th>                           
    <th id="th2" style="width:10%;">Manufacturer</th>                           
    <th id="th2" style="width:10%;">Salt brand</th>                           
    <th id="th2" style="width:6%;">Matrix/Other details</th>                           
    <th id="th2" style="width:8%;">IODINE (mg/kg IODATE)</th>  
    <th id="th2" style="width:12%;">Category</th>  
    <th id="th2" style="width:6%;">Month/Quarter</th>  
    <th id="th10" style="width:5%;">&nbsp;</th>                               
  </tr>                                                                         
  </thead>                                                                      
  <tbody id='results'>                                                          
    <%(@samples || []).each do |sample_id,values| %>                                    
    <tr>                                                                        
      <td id="date_<%=sample_id%>"><%=values[:date]%></td>                                            
      <td id="cis_code_<%=sample_id%>"><%=values[:cis_code]%></td>                                            
      <td id="manufacturer_<%=sample_id%>"><%=values[:manufacturer]%></td>                                            
      <td id="salt_brand_<%=sample_id%>"><%=values[:salt_brand]%></td>                                            
      <td id="other_<%=sample_id%>"><%=values[:other]%></td>                                            
      <td id="iodine_level_<%=sample_id%>"><%=values[:iodine_level]%></td>                                            
      <td id="category_<%=sample_id%>"><%=values[:category]%></td>                                            
      <td><%=values[:quarter]%></td>                                            
      <!--td><a href="/edit_industry/<%#=sample_id%>">Edit/delete</a></td-->       
      <td><a href="#" onclick="showLayer(<%=sample_id%>);fillForm(<%=sample_id%>);setDate();">Edit</a></td>
    </tr>                                                                       
    <%end%>                                                                     
  </tbody>                                                                      
  </table>
</section> 


<script>                                                                        
  dataT();                                                                      
</script>


<div id="shadow" class="shadowLayer"> </div>
<div id="question" class="dialogLayer" style="font-size: 0.9em;overflow: auto;background-color:#e0e0e0;">
  <div class="modal-header" >
    <button type="button" class="close" style="color: #000000 !important;" onmousedown="hideLayer()"><span aria-hidden="true" >&times;</span></button>
    <h2 id="popup_title">Edit</h2>
  </div>
<div >
<div id="comment_container" style="text-align: justify;background-color: #ebebeb;">

</div>

<div id="notice_container" style="text-align: left;">
  <form method="post" action="update_notice">
      &nbsp; <br/>
      <table id="popuptable">
        <tr>
          <td>Date</td><td><%=text_field(:input, "popupdate",:class => "input_data", :id => "popupdate", :readonly => "readonly") %></td>
        </tr>
        <tr>
          <td>CIS code</td><td><input type="text" name="cis_code" class='input_data' id="cis_code" /></td>
        </tr>
        <tr>
          <td>Salt type (Origin)</td>
          <td>
            <%@manufacturers.unshift('Select manufacturer') %>
            <%= select_tag "salt_brand", options_for_select(@manufacturers),
            :class => "input_data", :id => "salt_brand" %>
          </td>
        </tr>
        <tr>
          <td>Salt type</td>
          <td>
            <%@salt_types.unshift('Select salt type') %>
            <%= select_tag "salt_type", options_for_select(@salt_types),
            :class => "input_data", :id => "salt_type" %>
          </td>
        </tr>
        <tr>
          <td>Iodine level</td>
          <td>
            <input type="text" name="result" class='input_data' 
              onkeyup = "sampleIodineCategory(this);" id="iodine_level" />
          </td>
        </tr>
        <tr>
          <td>Category</td><td><input type="text" disabled='disabled' id="category" /></td>
        </tr>
      </table>
      <input type="hidden" name="record_id" id="record_id" value="" />
    <hr>
    <input type='button' style="float: right;" class="btn btn-success" value="Save changes" onmousedown="saveChanges()" id="save_changes">
    <button  class="btn btn-danger" style="float: right;margin-right: 10px;" onmousedown="hideLayer()">Close</button>
  </form>
</div>
</div>
 </div>
</div>


<script>

function sampleIodineCategory(element) {                                               
  sample_iodine_category = document.getElementById("category");
                                                          
  try{                                                                          
    var level = parseFloat(element.value);                          
    if(!level) {                                                                
      sample_iodine_category.value = null;                                      
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
                                                          
  if(level < 25){                                                               
    sample_iodine_category.value = "Below Market Min";                          
  }else if(level >= 25 && level <= 49.9 ){                                      
    sample_iodine_category.value = "Factory Min-Market Min";                    
  }else if(level < 50){                                                         
    sample_iodine_category.value = "< Factory Min";                             
  }else if(level >= 50 && level <= 84){                                         
    sample_iodine_category.value = "Production Range";                          
  }else if(level > 84){                                                         
    sample_iodine_category.value = "> Factory Max";                             
  }                                                                             

}

function saveChanges() {
  var selected_date = document.getElementById("popupdate"); 
  var cis_code = document.getElementById("cis_code"); 
  var company = document.getElementById("salt_brand"); 
  var salt_type = document.getElementById("salt_type"); 
  var entered_result = document.getElementById("iodine_level"); 
  var cat = document.getElementById("category"); 

  if (selected_date.value.length < 1) {
  }else if(cis_code.value.length < 1) {
  }else if(company.value.length < 1) {
  }else if(salt_type.value.length < 1) {
  }else if(entered_result.value.length < 1) {
  }else if(cat.value.length < 1) {
    return;
  }

  var url = "sample[cis_code]=" + cis_code.value;                                                                         
  url += "&sample[company]=" + company.value;                                                                         
  url += "&sample[salt_type]=" + salt_type.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;                                                                         
  url += "&sample[sample_id]=" + document.getElementById("record_id").value;

  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = xmlhttp.responseText;                                     
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          alert('Updated record');
          location.reload();
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/update_industry_datagrid?" + url, true);           
    xmlhttp.send();
}

  var all_salt_types = {};
  var all_manufacturers = {};

  <%@salt_types.each do |name,id|%>
    if(!all_salt_types["<%= name %>"])
      all_salt_types["<%= name %>"] = [];
 
    all_salt_types["<%= name %>"].push(<%= id %>); 
  <%end%>

  <%@manufacturers.each do |name,id|%>
    if(!all_manufacturers["<%= name %>"])
      all_manufacturers["<%= name %>"] = [];
 
    all_manufacturers["<%= name %>"].push(<%= id %>); 
  <%end%>

  var currDate = new Date();
  var dateNow =  currDate.getDate();
  var yrNow =  currDate.getFullYear();
  var monthNow =  (currDate.getMonth() + 1);

  function setDate(){
    new JsDatePick({
      useMode:2,
      target: 'popupdate' ,
      dateFormat:"%d-%M-%Y",
      selectedDate:{       
        day: dateNow,            
        month: monthNow,
        year: yrNow
      },
      yearsRange:[1900,yrNow],
      limitToToday: true,
      cellColorScheme:"beige",
      dateFormat:"%d-%m-%Y",
      imgPath:"img/",
      weekStartDay:1
    });
  };


  function fillForm(sample_id) {
    //document.getElementById('popupdate').value = document.getElementById("date_" + sample_id).innerHTML;                                             
    document.getElementById('cis_code').value = document.getElementById("cis_code_" + sample_id).innerHTML;                                             

    document.getElementById('salt_type').options[0].innerHTML = document.getElementById("salt_type_" + sample_id).innerHTML;                                             
    document.getElementById('salt_type').value = all_salt_types[document.getElementById("salt_type_" + sample_id).innerHTML];                                             
    
    document.getElementById('salt_brand').options[0].innerHTML = document.getElementById("salt_brand_" + sample_id).innerHTML;                                             
    document.getElementById('salt_brand').value = all_manufacturers[document.getElementById("salt_brand_" + sample_id).innerHTML];                                            

    //document.getElementById('volume').value = document.getElementById("volume_" + sample_id).innerHTML;                                             
    document.getElementById('iodine_level').value = document.getElementById("iodine_level_" + sample_id).innerHTML;                                             
    document.getElementById('category').value = document.getElementById("category_" + sample_id).innerHTML;                                             

  }
</script>

<style>
  .dialogLayer {
    height: 380px !important;
  }
</style>  
