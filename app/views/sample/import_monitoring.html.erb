<%=javascript_include_tag "prototype"%>                                         
<%=javascript_include_tag "jquery_data_table" %>                                
<%=javascript_include_tag "jquery.dataTables.min" %>                            

<%=javascript_include_tag "popup" %>                            
                                                                                
<%= stylesheet_link_tag "demo_table" %>                                         
<%= stylesheet_link_tag "demo_table_jui" %>                                     
<%= stylesheet_link_tag "demo_page" %>
<%= stylesheet_link_tag "popup" %>

<style>
                                                                                
</style>

<script>

  function dataT(){                                                               
    $('#search_results').dataTable();                                                  
  }

  function findStudents() {                                                       
    var search_str = document.getElementById('search_words').value;               
                                                                                
    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
        xmlhttp=new XMLHttpRequest();                                             
      }else{// code for IE6, IE5                                                  
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
      }                                                                           
      xmlhttp.onreadystatechange=function() {                                     
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
          var results = xmlhttp.responseText;                                     
          if(results == 'undefined' || results == '' || results == '"not validate"') {                           
            return;                                                               
          }else{                                                                  
            document.getElementById('results-cont').innerHTML = results;                                                           
            dataT();                                                              
          }                                                                       
        }                                                                         
      }                                                                           
      xmlhttp.open("GET","/assets/live_search?search_str="+search_str,true);           
      xmlhttp.send();                                                             
    } 
 
</script>


<div class="page-header">
  <h3>Import Control&nbsp;<small>SUMMARY OF SALT DETAILS AND RESULTS ENTERED</small></h3>
</div>

<section id='modals'>                                              
  <table id="search_results" class="table table-striped table-bordered table-condensed">
  <thead>                                                                       
  <tr id = 'table_head'>                                                        
    <th id="th2" style="width:6%;">Date</th>  
    <th id="th1" style="width:6%;">IIR code</th>                           
    <th id="th2" style="width:10%;">Point of Entry</th>                           
    <th id="th2" style="width:10%;">Importer</th>                           
    <th id="th2" style="width:10%;">Salt brand</th>                           
    <th id="th2" style="width:10%;">Country of origin</th>                           
    <th id="th2" style="width:5%;">volume (tons)</th>  
    <th id="th2" style="width:5%;">IODINE (mg/kg IODATE)</th>  
    <th id="th2" style="width:12%;">Category</th>  
    <th id="th10" style="width:5%;">&nbsp;</th>                               
  </tr>                                                                         
  </thead>                                                                      
  <tbody id='results'>                                                          
    <%(@samples || []).each do |sample_id,values| %>                                    
    <tr>                                                                        
      <td id="date_<%=sample_id%>"><%=values[:date]%></td>                                            
      <td id="iir_code_<%=sample_id%>"><%=values[:iir_code]%></td>                                            
      <td id="border_<%=sample_id%>"><%=values[:border]%></td>                                            
      <td id="importer_<%=sample_id%>"><%=values[:importer]%></td>                                            
      <td id="salt_brand_<%=sample_id%>"><%=values[:salt_brand]%></td>                                            
      <td id="country_<%=sample_id%>"><%=values[:country]%></td>                                            
      <td id="volume_<%=sample_id%>"><%=values[:volume]%></td>                                            
      <td id="iodine_level_<%=sample_id%>"><%=values[:iodine_level]%></td>                                            
      <td id="category_<%=sample_id%>"><%=values[:category]%></td>                                            
      <!--td><a href="/edit_import/<%#=sample_id%>">Edit/delete</a></td-->       
      <td><a href="#" onclick="showLayer(<%=sample_id%>);fillForm(<%=sample_id%>);setDate();">Edit</a></td>       
    </tr>                                                                       
    <%end%>                                                                     
  </tbody>                                                                      
  </table>
</section> 


<script>                                                                        
  dataT();                                                                      
</script>


<div id="shadow" class="shadowLayer"> </div>
<div id="question" class="dialogLayer" style="font-size: 0.9em;overflow: auto;background-color:#e0e0e0;">
  <div class="modal-header" >
    <button type="button" class="close" style="color: #000000 !important;" onmousedown="hideLayer()"><span aria-hidden="true" >&times;</span></button>
    <h2 id="popup_title">Edit</h2>
  </div>
<div >
<div id="comment_container" style="text-align: justify;background-color: #ebebeb;">

</div>

<div id="notice_container" style="text-align: left;">
  <form method="post" action="update_notice">
      &nbsp; <br/>
      <table id="popuptable">
        <tr>
          <td>Date</td><td><%=text_field(:input, "popupdate",:class => "input_data", :id => "popupdate", :readonly => "readonly") %></td>
        </tr>
        <tr>
          <td>IIR Code</td><td><input type="text" name="iir_code" class='input_data' id="iir_code" /></td>
        </tr>
        <tr>
          <td>Point of Entry</td>
          <td>
            <%@borders.unshift('Select entry point') %>
            <%= select_tag "border", options_for_select(@borders),
            :class => "input_data", :id => "border" %>
          </td>
        </tr>
        <tr>
          <td>Importer</td>
          <td>
            <%@transporters.unshift('Select transporter') %>
            <%= select_tag "transporter", options_for_select(@transporters),
            :class => "input_data", :id => "transporter" %>
          </td>
        </tr>
        <tr>
          <td>Salt brand</td>
          <td>
            <%@products.unshift('Select salt brand') %>
            <%= select_tag "salt_brand", options_for_select(@products),
            :class => "input_data", :id => "salt_brand" %>
          </td>
        </tr>
        <tr>
          <td>Salt brand (origin)</td>
          <td>
            <%@countries.unshift('Select country') %>
            <%= select_tag "country", options_for_select(@countries),
            :class => "input_data", :id => "country" %>
          </td>
        </tr>
        <tr>
          <td>Volume of import</td><td><input type="text" name="volume" id="volume" /></td>
        </tr>
        <tr>
          <td>Result</td>
          <td>
            <input type="text" name="result" class='input_data' 
              onkeyup = "sampleIodineCategory(this);" id="result" />
          </td>
        </tr>
        <tr>
          <td>Category</td><td><input type="text" disabled='disabled' id="category" /></td>
        </tr>
      </table>
      <input type="hidden" name="record_id" id="record_id" value="" />
    <hr>
    <input type='button' style="float: right;" class="btn btn-success" value="Save changes" onmousedown="saveChanges()" id="save_changes">
    <button  class="btn btn-danger" style="float: right;margin-right: 10px;" onmousedown="hideLayer()">Close</button>
  </form>
</div>
</div>

 </div>
</div>


<%= stylesheet_link_tag "DatePicker/jsDatePick_ltr.min" %>
<%= javascript_include_tag "DatePicker/jsDatePick.min.1.3" %>

<script>

function fillForm(sample_id) {
  //document.getElementById('popupdate').value = document.getElementById("date_" + sample_id).innerHTML;                                             
  document.getElementById('iir_code').value = document.getElementById("iir_code_" + sample_id).innerHTML;                                             

  document.getElementById('border').options[0].innerHTML = document.getElementById("border_" + sample_id).innerHTML;                                             
  document.getElementById('border').value = all_borders[document.getElementById("border_" + sample_id).innerHTML];                                             

  document.getElementById('transporter').options[0].innerHTML = document.getElementById("importer_" + sample_id).innerHTML;                                             
  document.getElementById('transporter').value = all_transporters[document.getElementById("importer_" + sample_id).innerHTML];                                             

  document.getElementById('salt_brand').options[0].innerHTML = document.getElementById("salt_brand_" + sample_id).innerHTML;                                             
  document.getElementById('salt_brand').value = all_salt_brands[document.getElementById("salt_brand_" + sample_id).innerHTML];                                             
  
  document.getElementById('country').options[0].innerHTML = document.getElementById("country_" + sample_id).innerHTML;                                             
  document.getElementById('country').value = all_countries[document.getElementById("country_" + sample_id).innerHTML];                                             

  document.getElementById('volume').value = document.getElementById("volume_" + sample_id).innerHTML;                                             
  document.getElementById('result').value = document.getElementById("iodine_level_" + sample_id).innerHTML;                                             
  document.getElementById('category').value = document.getElementById("category_" + sample_id).innerHTML;                                             

}

function sampleIodineCategory(element) {                                               
  sample_iodine_category = document.getElementById('category');
                                                          
  try{                                                                          
    var level = parseFloat(element.value);                          
    if(!level) {                                                                
      sample_iodine_category.value = null;                                      
      return;                                                                   
    }                                                                           
  }catch(e){}                                                                   
                                                          
  if(level < 25){                                                               
    sample_iodine_category.value = "Below Market Min";                          
  }else if(level >= 25 && level <= 49.9 ){                                      
    sample_iodine_category.value = "Factory Min-Market Min";                    
  }else if(level < 50){                                                         
    sample_iodine_category.value = "< Factory Min";                             
  }else if(level >= 50 && level <= 84){                                         
    sample_iodine_category.value = "Production Range";                          
  }else if(level > 84){                                                         
    sample_iodine_category.value = "> Factory Max";                             
  }                                                                             

}

  var currDate = new Date();
  var dateNow =  currDate.getDate();
  var yrNow =  currDate.getFullYear();
  var monthNow =  (currDate.getMonth() + 1);


  function setDate(){
    new JsDatePick({
      useMode:2,
      target: 'popupdate' ,
      dateFormat:"%d-%M-%Y",
      selectedDate:{       
        day: dateNow,            
        month: monthNow,
        year: yrNow
      },
      yearsRange:[1900,yrNow],
      limitToToday: true,
      cellColorScheme:"beige",
      dateFormat:"%d-%m-%Y",
      imgPath:"img/",
      weekStartDay:1
    });
  };



function saveChanges() {
  if(document.getElementById('popupdate').value.length < 1)
    return;

  var selected_date = document.getElementById("popupdate"); 
  var iir_code = document.getElementById('iir_code'); 
  var entry = document.getElementById('border'); 
  var importer = document.getElementById('transporter'); 
  var brand = document.getElementById('salt_brand'); 
  var country = document.getElementById('country'); 
  var volume = document.getElementById('volume'); 
  var entered_result = document.getElementById('result'); 
  var cat = document.getElementById('category'); 

  if (selected_date.value.length < 1) {
  }else if(iir_code.value.length < 1) {
  }else if(entry.value.length < 1) {
  }else if(importer.value.length < 1) {
  }else if(brand.value.length < 1) {
  }else if(volume.value.length < 1) {
  }else if(entered_result.value.length < 1) {
  }else if(country.value.length < 1) {
  }else if(cat.value.length < 1) {
    return;
  }

  var url = "sample[iir_code]=" + iir_code.value;                                                                         
  url += "&sample[border]=" + entry.value;                                                                         
  url += "&sample[importer]=" + importer.value;                                                                         
  url += "&sample[salt_brand]=" + brand.value;                                                                         
  url += "&sample[country]=" + country.value;                                                                         
  url += "&sample[volume]=" + volume.value;                                                                         
  url += "&sample[iodine_level]=" + entered_result.value;                                                                         
  url += "&sample[category]=" + cat.value;                                                                         
  url += "&sample[date]=" + selected_date.value;                                                                         

  url += "&sample[sample_id]=" + document.getElementById('record_id').value;

  if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari  
      xmlhttp=new XMLHttpRequest();                                             
    }else{// code for IE6, IE5                                                  
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");                           
    }                                                                           
    xmlhttp.onreadystatechange=function() {                                     
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {                       
        var results = xmlhttp.responseText;                                     
        var results = JSON.parse(xmlhttp.responseText);  
        if(results.match("sample id:")) {
          alert('Record updated ....');
          selected_date.value = null; iir_code.value = null;
          volume.value = null; entered_result.value = null;
          cat.value = null; 
          location.reload(); 
        }                                                                     
      }                                                                         
    }  
    
    
    xmlhttp.open("GET","/update_quality_monitoring_raw_data?" + url, true);           
    xmlhttp.send();                                                             
  }






  var all_borders = {};
  var all_transporters = {};
  var all_salt_brands = {};
  var all_countries = {};

  <%@borders.each do |name,id|%>
    if(!all_borders["<%= name %>"])
      all_borders["<%= name %>"] = [];
 
    all_borders["<%= name %>"].push(<%= id %>); 
  <%end%>

  <%@transporters.each do |name,id|%>
    if(!all_transporters["<%= name %>"])
      all_transporters["<%= name %>"] = [];
 
    all_transporters["<%= name %>"].push(<%= id %>); 
  <%end%>

  <%@products.each do |name,id|%>
    if(!all_salt_brands["<%= name %>"])
      all_salt_brands["<%= name %>"] = [];
 
    all_salt_brands["<%= name %>"].push(<%= id %>); 
  <%end%>

  <%@countries.each do |name,id|%>
    if(!all_countries["<%= name %>"])
      all_countries["<%= name %>"] = [];
 
    all_countries["<%= name %>"].push(<%= id %>); 
  <%end%>



</script>


